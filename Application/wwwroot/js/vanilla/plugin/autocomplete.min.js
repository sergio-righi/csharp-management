(function(n,t){typeof define=="function"&&define.amd?define(t):typeof exports=="object"?module.exports=t():n.autocomplete=t()})(this,function(){function f(n){return dataStorage.get(n,"autocomplete")}function t(n,t){this.chips=[];this.items=null;this.element=n;this.configurations={focus:!1,required:!1,readOnly:!1};this.options=g({},{min:0,limit:8,max:null,onLoad:null,onInput:null,"return":"TEXT",duplicity:!1},t);this.init()}function o(){this.element.classList.add("d-none");this.autocomplete=document.createElement("div");this.autocomplete.classList.add("autocomplete");this.component=document.createElement("input");this.component.setAttribute("type","text");this.element.autofocus!==undefined&&this.component.setAttribute("autofocus",this.element.autofocus);this.element.placeholder!==undefined&&this.component.setAttribute("placeholder",this.element.placeholder);this.component.classList.add("autocomplete-component");this.options.onInput!==null||this.options.onLoad!==null?(this.dropdown=document.createElement("div"),this.dropdown.classList.add("autocomplete-dropdown"),this.dropdownContent=document.createElement("ul"),this.dropdownContent.classList.add("dropdown-content"),this.dropdown.appendChild(this.component),this.dropdown.appendChild(this.dropdownContent),this.autocomplete.appendChild(this.dropdown)):this.autocomplete.appendChild(this.component);this.element.parentNode.insertBefore(this.autocomplete,this.element)}function i(){this.configurations.focus=this.element.hasAttribute("autofocus");this.focus&&this.component.focus();this.configurations.required=this.element.hasAttribute("required");this.configurations.required&&(this.component.setAttribute("required","required"),this.element.removeAttribute("required"));this.configurations.readOnly=this.element.hasAttribute("readonly")||this.element.hasAttribute("disabled");this.configurations.readOnly&&this.component.classList.add("d-none")}function s(){let n=[],t=this,i=this.element.value.isJSON();n=i?JSON.parse(this.element.value):this.element.value.split(",");Array.prototype.forEach.call(n,function(n){i?t.add(n.ID,n.TEXT.trim()):t.add(0,n.trim())})}function h(n,t){let i=document.createElement("span");return i.title=t,i.className="chip",i.setAttribute("data-id",n),i.setAttribute("data-text",t),i.setAttribute("data-key",Math.random().toString(36).substr(2,16)),i.innerHTML='<span class="chip-title">'+t+"<\/span>",this.configurations.readOnly||(i.innerHTML+='<span class="chip-control"><\/span>'),i}function c(){this._events={formReset:this.reset.bind(this),formSubmit:l.bind(this),componentBlur:p.bind(this),componentFocus:y.bind(this),componentKeyUp:a.bind(this),componentKeyDown:v.bind(this),chipControlRemove:w.bind(this),autocompleteClick:b.bind(this),dropdownContentMouseDown:k.bind(this)};this.element.form!==null&&(this.element.form.addEventListener("reset",this._events.formReset),this.element.form.addEventListener("submit",this._events.formSubmit));this.component.addEventListener("blur",this._events.componentBlur);this.component.addEventListener("focus",this._events.componentFocus);this.component.addEventListener("keydown",this._events.componentKeyDown);(this.options.onInput!==null||this.options.onLoad!==null)&&(this.component.addEventListener("keyup",this._events.componentKeyUp),this.dropdownContent.addEventListener("mousedown",this._events.dropdownContentMouseDown));this.autocomplete.addEventListener("click",this._events.autocompleteClick);document.addEventListener("mouseup",this._events.chipControlRemove)}function l(n){if(this.chips.length>=this.options.min&&(this.options.max===null||this.options.max>=this.chips.length)){if(!this.configurations.readOnly){let n=[];const t=this;this.chips.forEach(function(i){t.options.return==="ID"?n.push(i.id):n.push(i.text)});this.element.value=n.join(", ")}}else n.preventDefault()}function a(t){if(this.component.value.length>0){if(t.which!==n.up&&t.which!==n.down){let n=[];if(this.showing=0,this.typingTimer&&clearTimeout(this.typingTimer),this.options.onInput!==null)this.options.onInput(this);if(this.items!==null){let t=this;this.typingTimer=setTimeout(function(){let i=t.items.searchFor(t.component.value,t.chips,t.options.duplicity,t.options.limit);i.length>0?(t.showing=i.length,t.dropdown.classList.add("active"),Array.prototype.forEach.call(i,function(t,i){let r=document.createElement("li");i===0&&(r.className="selected");typeof t=="string"?(r.innerText=t,r.setAttribute("data-id",0)):(r.innerText=t.TEXT,r.setAttribute("data-id",t.ID));n.push(r.outerHTML)})):t.dropdown.classList.remove("active");t.dropdownContent.innerHTML=n.join("")},100)}else this.dropdown.classList.remove("active")}}else{this.dropdown.classList.remove("active");let n=this.dropdownContent.querySelectorAll("li.selected")[0];n!==undefined&&n.classList.remove("selected")}return!1}function v(t){switch(t.which){case n.esc:this.component.value="";this.dropdown!==undefined&&this.dropdown.classList.remove("active");break;case n.backspace:if(this.chips.length>0&&this.component.value.length===0){let n=this.getLast();n!==null&&(n=n.previousElementSibling,n.classList.contains("chip")&&(n.classList.contains("active")?this.remove(n):n.classList.add("active")))}break;case n.tab:case n.enter:if(this.component.value.length>0&&t.preventDefault(),this.options.onInput!==null||this.options.onLoad!==null){if(this.dropdown.classList.remove("active"),this.showing>0){let n=this.dropdownContent.querySelectorAll("li.selected")[0];n!==undefined&&(this.add(n.dataset.id,n.textContent),n.classList.remove("selected"))}this.component.value=""}else this.component.value.length>0&&(this.options.duplicity||!this.options.duplicity&&this.chips.indexOf(this.component.value.toISO())===-1)&&this.add(0,this.component.value);break;case n.up:case n.down:if((this.options.onInput!==null||this.options.onLoad!==null)&&(t.preventDefault(),this.dropdown.classList.contains("active")&&this.showing>0)){let i=null,t=this.dropdownContent.querySelectorAll("li.selected")[0];const r=t.index();e.which===n.CIMA?r!==0?(i=t.previousElementSibling,i.classList.add("selected"),t.classList.remove("selected")):(i=t.parentNode.lastElementChild,i.classList.add("selected"),t.classList.remove("selected")):e.which===n.BAIXO&&(r!==this.showing-1?(i=t.nextElementSibling,i.classList.add("selected"),t.classList.remove("selected")):(i=t.parentNode.firstElementChild,i.classList.add("selected"),t.classList.remove("selected")))}break;default:if(this.chips.length>0){let n=this.getLast();n.classList.contains("chip")&&n.classList.remove("active")}}}function y(){this.component.value="";this.autocomplete.classList.add("focus");this.dropdown!==undefined&&this.dropdown.classList.remove("active")}function p(){this.component.value="";this.autocomplete.classList.remove("focus");this.dropdown!==undefined&&this.dropdown.classList.remove("active")}function w(n){n.target&&n.target.className==="chip-control"&&this.remove(n.target.parentNode)}function b(){this.component.focus()}function k(n){if(n.target&&n.target.nodeName==="LI"){let t=this.add(n.target.dataset.id,n.target.textContent);t!==null&&(this.dropdown.classList.remove("active"),this.component.value="",this.component.focus())}}function d(){this.element.form!==null&&(this.element.form.removeEventListener("reset",this._events.formReset),this.element.form.removeEventListener("submit",this._events.formSubmit));this.component.removeEventListener("blur",this._events.componentBlur);this.component.removeEventListener("focus",this._events.componentFocus);this.component.removeEventListener("keydown",this._events.componentKeyDown);(this.options.onInput!==null||this.options.onLoad!==null)&&(this.component.removeEventListener("keyup",this._events.componentKeyUp),this.dropdownContent.removeEventListener("mousedown",this._events.dropdownContentMouseDown));this.autocomplete.removeEventListener("click",this._events.autocompleteClick);document.removeEventListener("mouseup",this._events.chipControlRemove)}function r(){(this.configurations.required||this.options.min!==null)&&(this.chips.length===0||this.options.min!==null&&this.options.min>this.chips.length?this.component.setAttribute("required","required"):this.component.removeAttribute("required"))}function u(){this.options.max===null||this.chips.length<=this.options.max-1?(this.component.classList.remove("d-none"),this.component.focus()):(this.component.blur(),this.component.classList.add("d-none"))}function g(){for(var t,n=1;n<arguments.length;n++)for(t in arguments[n])arguments[n].hasOwnProperty(t)&&(arguments[0][t]=arguments[n][t]);return arguments[0]}const n={tab:9,up:38,esc:27,down:40,enter:13,backspace:8};return t.prototype.init=function(){if(!this.autocomplete){if(o.call(this),i.call(this),this.options.onLoad!==null)this.options.onLoad(this);return c.call(this),this.element.value.length>0&&s.call(this),dataStorage.put(this.element,"autocomplete",this),this}},t.prototype.destroy=function(){this.autocomplete!==null&&(d.call(this),this.autocomplete.parentNode.removeChild(this.autocomplete),this.autocomplete=null)},t.prototype.update=function(){return i.call(this),this},t.prototype.getLast=function(){return typeof this.dropdown!="undefined"?this.dropdown:this.component},t.prototype.add=function(n,t){let i=h.call(this,n,t);if(i!==null){let n=this.getLast();n!==null&&(n.parentNode.insertBefore(i,n),this.chips.push({id:i.dataset.id,text:i.dataset.text,key:i.dataset.key}),u.call(this),r.call(this));this.component.value=""}return i},t.prototype.remove=function(n){const t=this.chips.findIndex(t=>t.key===n.dataset.key);t!==-1&&(this.chips.splice(t,1),n.parentNode.removeChild(n));u.call(this);r.call(this)},t.prototype.reset=function(){return this.chips=[],this.component.classList.remove("d-none"),this},Element.prototype.index=function(){return Array.from(this.parentElement.children).indexOf(this)},String.prototype.normalize=function(){return this.toLowerCase().toISO()},String.prototype.toISO=function(){return this.toUpperCase().replace(new RegExp("[ÁÀÂÃÄ]","gi"),"A").replace(new RegExp("[ÉÈÊË]","gi"),"E").replace(new RegExp("[ÍÌÎÏ]","gi"),"I").replace(new RegExp("[ÓÒÔÕÖ]","gi"),"O").replace(new RegExp("[ÚÙÛÜ]","gi"),"U").replace(new RegExp("[Ç]","gi"),"C").toLowerCase()},String.prototype.isJSON=function(){try{JSON.parse(this)}catch(n){return!1}return!0},Array.prototype.searchFor=function(n,t,i,r){let u=[];return this.forEach(function(f){return typeof f=="string"?f.normalize().match(n.normalize())&&(i||!i&&t.findIndex(n=>n.text.normalize()===f.normalize())===-1)&&u.push(f):f.TEXT.normalize().match(n.normalize())&&(i||!i&&t.findIndex(n=>n.text.normalize()===f.TEXT.normalize())===-1)&&u.push(f),u.length===r?!1:void 0}),u},{init:t,get:f}});